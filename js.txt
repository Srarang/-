let currentScreen = 'main-screen';
let screenHistory = [];
let selectedFacility = '';
let selectedTime = '';

// âœ… ë‚ ì§œ ìë™ ì´ˆê¸°í™” ì²´í¬
const todayDateStr = new Date().toLocaleDateString('ko-KR');
const lastDate = localStorage.getItem('lastUsedDate');
if (lastDate && lastDate !== todayDateStr) {
  localStorage.removeItem('reservations');
  localStorage.removeItem('existingReservations');
}
localStorage.setItem('lastUsedDate', todayDateStr);

// ğŸ” localStorageì—ì„œ ê¸°ì¡´ ì˜ˆì•½ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
let reservations = JSON.parse(localStorage.getItem('reservations')) || [];
let existingReservations = JSON.parse(localStorage.getItem('existingReservations')) || {};

function saveToLocalStorage() {
  localStorage.setItem('reservations', JSON.stringify(reservations));
  localStorage.setItem('existingReservations', JSON.stringify(existingReservations));
  localStorage.setItem('lastUsedDate', todayDateStr);
}

function resetReservations() {
  if (confirm("ëª¨ë“  ì˜ˆì•½ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
    localStorage.removeItem('reservations');
    localStorage.removeItem('existingReservations');
    reservations = [];
    existingReservations = {};
    alert("ì´ˆê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    location.reload();
  }
}

function showScreen(screenId) {
  document.getElementById(currentScreen).classList.remove('active');
  screenHistory.push(currentScreen);
  currentScreen = screenId;
  document.getElementById(screenId).classList.add('active');
  updateBackButton();

  if (screenId === 'datetime-screen') initializeDateTimeScreen();
  else if (screenId === 'status-screen') loadReservationStatus();
  else if (screenId === 'all-status-screen') loadAllStatus();
}

function goBack() {
  if (screenHistory.length > 0) {
    const previousScreen = screenHistory.pop();
    document.getElementById(currentScreen).classList.remove('active');
    currentScreen = previousScreen;
    document.getElementById(currentScreen).classList.add('active');
    updateBackButton();
  }
}

function updateBackButton() {
  const backBtn = document.querySelector('.back-btn');
  backBtn.style.display = (currentScreen === 'main-screen') ? 'none' : 'flex';
}

function selectFacility(element) {
  document.querySelectorAll('.facility-card').forEach(card => card.classList.remove('selected'));
  element.classList.add('selected');
  selectedFacility = element.querySelector('.facility-name').textContent;
}

function initializeDateTimeScreen() {
  const today = new Date();
  const todayStr = today.toLocaleDateString('ko-KR', {
    year: 'numeric', month: 'long', day: 'numeric', weekday: 'short'
  });
  document.getElementById('today-date').textContent = todayStr;
  updateTimeSlotAvailability();
}

function updateTimeSlotAvailability() {
  const timeSlots = document.querySelectorAll('.time-slot');
  const facilityReservations = existingReservations[selectedFacility] || [];

  timeSlots.forEach(slot => {
    const timeData = slot.getAttribute('data-time');
    slot.classList.remove('unavailable', 'selected');
    if (facilityReservations.includes(timeData)) {
      slot.classList.add('unavailable');
    }
  });
}

function selectTimeSlot(element) {
  if (element.classList.contains('unavailable')) return;
  document.querySelectorAll('.time-slot').forEach(slot => slot.classList.remove('selected'));
  element.classList.add('selected');
  selectedTime = element.getAttribute('data-time');
}

function completeReservation() {
  const userName = document.getElementById('user-name').value;
  const userBirth = document.getElementById('user-birth').value;
  const userPhone = document.getElementById('user-phone').value;

  if (!userName || !userBirth || !userPhone || !selectedFacility || !selectedTime) {
    alert('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }

  const today = new Date().toLocaleDateString('ko-KR');
  const reservation = {
    name: userName,
    birth: userBirth,
    phone: userPhone,
    facility: selectedFacility,
    date: today,
    time: selectedTime,
    id: Date.now()
  };

  reservations.push(reservation);
  if (!existingReservations[selectedFacility]) {
    existingReservations[selectedFacility] = [];
  }
  existingReservations[selectedFacility].push(selectedTime);

  saveToLocalStorage();
  updateSuccessScreen(selectedFacility, today, selectedTime);
  showScreen('success-screen');
}

function updateSuccessScreen(facility, date, time) {
  const successScreen = document.getElementById('success-screen');
  const infoDiv = successScreen.querySelector('div[style*="background:#f8f9fa"]');
  infoDiv.innerHTML = `
    <p><strong>ì‹œì„¤:</strong> ${facility}</p>
    <p><strong>ë‚ ì§œ:</strong> ${date}</p>
    <p><strong>ì‹œê°„:</strong> ${time}</p>
  `;
}

function loadReservationStatus() {
  const reservationList = document.getElementById('reservation-list');
  if (reservations.length === 0) {
    reservationList.innerHTML = `<div class="no-reservations">ğŸ“ ì•„ì§ ì˜ˆì•½ëœ ì‹œì„¤ì´ ì—†ìŠµë‹ˆë‹¤.<br>ìƒˆë¡œìš´ ì˜ˆì•½ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</div>`;
  } else {
    let html = '';
    reservations.forEach(r => {
      html += `<div class="reservation-item">
        <h3>ğŸ¢ ${r.facility}</h3>
        <p><strong>ğŸ‘¤ ì˜ˆì•½ì:</strong> ${r.name}</p>
        <p><strong>ğŸ“… ë‚ ì§œ:</strong> ${r.date}</p>
        <p><strong>â° ì‹œê°„:</strong> ${r.time}</p>
        <p><strong>ğŸ“ ì—°ë½ì²˜:</strong> ${r.phone}</p>
      </div>`;
    });
    reservationList.innerHTML = html;
  }
}

function loadAllStatus() {
  const today = new Date();
  const todayStr = today.toLocaleDateString('ko-KR', {
    year: 'numeric', month: 'long', day: 'numeric', weekday: 'short'
  });
  document.getElementById('all-status-date').textContent = todayStr;

  const timetableBody = document.getElementById('timetable-body');
  const timeSlots = ['09:00-10:00','10:00-11:00','11:00-12:00','13:00-14:00','14:00-15:00','15:00-16:00','16:00-17:00','17:00-18:00','18:00-19:00','19:00-20:00'];
  const facilities = ['ë‹Œí…ë„','í”Œë ˆì´ìŠ¤í…Œì´ì…˜','ë…¸ë˜ë°©','ë³´ë“œê²Œì„','ëŒ„ìŠ¤ì—°ìŠµì‹¤','ê°•ì˜ì‹¤'];
  let html = '';

  timeSlots.forEach(time => {
    html += `<tr><td class="time-cell">${time}</td>`;
    facilities.forEach(fac => {
      const isReserved = existingReservations[fac]?.includes(time);
      const r = reservations.find(r => r.facility === fac && r.time === time);
      html += `<td class="${isReserved ? 'reserved' : 'available'}">${r?.name || (isReserved ? 'ì˜ˆì•½ë¨' : '-')}</td>`;
    });
    html += `</tr>`;
  });

  timetableBody.innerHTML = html;
}

document.addEventListener('DOMContentLoaded', function () {
  const phoneInput = document.getElementById('user-phone');
  if (phoneInput) {
    phoneInput.addEventListener('input', function (e) {
      let value = e.target.value.replace(/[^0-9]/g, '');
      if (value.length >= 3) {
        if (value.length <= 7) {
          value = value.replace(/(\d{3})(\d{1,4})/, '$1-$2');
        } else {
          value = value.replace(/(\d{3})(\d{4})(\d{1,4})/, '$1-$2-$3');
        }
      }
      e.target.value = value;
    });
  }
});

function goToMainAndClear() {
  clearUserInputs();
  showScreen("main-screen");
}

function clearUserInputs() {
  document.getElementById("user-name").value = "";
  document.getElementById("user-birth").value = "";
  document.getElementById("user-phone").value = "";
  selectedFacility = "";
  selectedTime = "";

  // ì„ íƒëœ ì‹œì„¤ ì¹´ë“œ ì´ˆê¸°í™”
  document.querySelectorAll(".facility-card").forEach((card) => {
    card.classList.remove("selected");
  });

  // ì„ íƒëœ ì‹œê°„ ìŠ¬ë¡¯ ì´ˆê¸°í™”
  document.querySelectorAll(".time-slot").forEach((slot) => {
    slot.classList.remove("selected");
  });
}

function showScreen(screenId) {
  document.getElementById(currentScreen).classList.remove("active");
  screenHistory.push(currentScreen);
  currentScreen = screenId;
  document.getElementById(screenId).classList.add("active");
  updateBackButton();

  // ì‚¬ìš©ì ì •ë³´ ì…ë ¥ í™”ë©´ìœ¼ë¡œ ê°ˆ ë•Œ ì´ì „ ì •ë³´ ì´ˆê¸°í™”
  if (screenId === "user-info-screen") {
    clearUserInputs();
  } else if (screenId === "datetime-screen") {
    initializeDateTimeScreen();
  } else if (screenId === "status-screen") {
    loadReservationStatus();
  } else if (screenId === "all-status-screen") {
    loadAllStatus();
  }
}
